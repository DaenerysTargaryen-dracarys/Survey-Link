<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Survey Link Generator</title>
<style>
    /* Ultra-compact, clean design */
    :root {
        --bg: #f9fafb;
        --card: #ffffff;
        --text: #111827;
        --text-light: #6b7280;
        --primary: #3b82f6;
        --success: #10b981;
        --warning: #f59e0b;
        --danger: #ef4444;
        --border: #e5e7eb;
        --radius: 8px;
        --shadow: 0 1px 3px rgba(0,0,0,0.1);
        --maxw: 800px;
    }

    /* Base */
    * {
        box-sizing: border-box;
    }

    html, body {
        margin: 0;
        padding: 6px;
        background: var(--bg);
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        font-size: 13px;
        line-height: 1.3;
        color: var(--text);
        height: 100%;
    }

    /* Container */
    .container {
        max-width: var(--maxw);
        margin: 0 auto;
        background: var(--card);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        border: 1px solid var(--border);
        padding: 12px;
    }

    /* Header */
    h1 {
        margin: 0 0 10px 0;
        font-size: 16px;
        font-weight: 600;
        text-align: center;
        color: var(--primary);
        padding-bottom: 8px;
        border-bottom: 1px solid var(--border);
    }

    /* File Upload - Compact */
    .file-section {
        display: flex;
        gap: 8px;
        align-items: center;
        margin-bottom: 10px;
        padding: 8px;
        background: #f8fafc;
        border-radius: var(--radius);
        border: 1px dashed var(--border);
    }

    .file-input-container {
        display: flex;
        gap: 8px;
        align-items: center;
        flex: 1;
        min-width: 0;
    }

    .file-label {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 10px;
        background: var(--primary);
        color: white;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 500;
        cursor: pointer;
        white-space: nowrap;
        border: none;
    }

    input[type="file"] {
        display: none;
    }

    .file-name {
        flex: 1;
        min-width: 0;
        padding: 6px 8px;
        background: white;
        border: 1px solid var(--border);
        border-radius: 6px;
        font-size: 12px;
        color: var(--text-light);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    /* Button Groups - Dense */
    .button-group {
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
        margin-bottom: 10px;
    }

    .btn {
        padding: 6px 10px;
        border-radius: 6px;
        border: 1px solid transparent;
        font-size: 12px;
        font-weight: 500;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 4px;
        transition: all 0.15s ease;
        white-space: nowrap;
        height: 32px;
    }

    .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .btn:active {
        transform: translateY(0);
    }

    .btn-primary {
        background: var(--primary);
        color: white;
    }

    .btn-success {
        background: var(--success);
        color: white;
    }

    .btn-warning {
        background: var(--warning);
        color: white;
    }

    .btn-info {
        background: #7c3aed;
        color: white;
    }

    .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none !important;
        box-shadow: none !important;
    }

    /* Status - Minimal */
    .status {
        padding: 6px 10px;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 500;
        margin-bottom: 10px;
        border: 1px solid;
        display: none;
    }

    .status.success {
        background: #ecfdf5;
        color: #065f46;
        border-color: #a7f3d0;
    }

    .status.error {
        background: #fef2f2;
        color: #991b1b;
        border-color: #fecaca;
    }

    /* Filters & Search - Compact */
    .filter-container {
        display: flex;
        gap: 6px;
        margin-bottom: 10px;
        flex-wrap: wrap;
    }

    .filter-btn {
        padding: 4px 8px;
        border-radius: 6px;
        border: 1px solid var(--border);
        background: white;
        font-size: 11px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.15s ease;
    }

    .filter-btn:hover {
        border-color: var(--primary);
    }

    .filter-btn.active {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
    }

    .search-container {
        display: flex;
        gap: 6px;
        margin-bottom: 10px;
        align-items: center;
        flex-wrap: wrap;
    }

    .search-box {
        flex: 1;
        min-width: 200px;
        max-width: 300px;
        padding: 6px 8px;
        border: 1px solid var(--border);
        border-radius: 6px;
        font-size: 12px;
        height: 32px;
    }

    .search-box:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .search-btn, .clear-search {
        padding: 6px 10px;
        border-radius: 6px;
        border: 1px solid var(--border);
        background: white;
        font-size: 12px;
        cursor: pointer;
        height: 32px;
    }

    /* Table - Ultra Compact with 3 columns only */
    .table-container {
        border: 1px solid var(--border);
        border-radius: var(--radius);
        overflow: auto;
        max-height: 400px;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        font-size: 12px;
        min-width: 400px;
    }

    thead {
        position: sticky;
        top: 0;
        background: #f9fafb;
        z-index: 10;
    }

    thead th {
        padding: 8px 10px;
        text-align: left;
        font-weight: 600;
        color: var(--text-light);
        border-bottom: 2px solid var(--border);
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    tbody tr {
        border-bottom: 1px solid var(--border);
        transition: background 0.15s ease;
    }

    tbody tr:hover {
        background: #f3f4f6;
    }

    tbody td {
        padding: 6px 10px;
        vertical-align: middle;
    }

    /* Column widths for 3-column layout */
    th:nth-child(1), td:nth-child(1) {
        width: 45%;
    }
    
    th:nth-child(2), td:nth-child(2) {
        width: 35%;
    }
    
    th:nth-child(3), td:nth-child(3) {
        width: 20%;
        text-align: center;
    }

    /* Sales Type badges */
    .sales-type-badge {
        display: inline-block;
        padding: 3px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 500;
        text-align: center;
        min-width: 70px;
    }

    .badge-dinein {
        background: #dcfce7;
        color: #166534;
        border: 1px solid #86efac;
    }

    .badge-takeaway {
        background: #dbeafe;
        color: #1e40af;
        border: 1px solid #93c5fd;
    }

    .badge-delivery {
        background: #f3e8ff;
        color: #6b21a8;
        border: 1px solid #d8b4fe;
    }

    /* Action buttons */
    .action-buttons {
        display: flex;
        gap: 4px;
        justify-content: center;
    }

    .copy-btn {
        padding: 4px 8px;
        border-radius: 4px;
        background: var(--success);
        color: white;
        border: none;
        font-size: 11px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.15s ease;
        width: 60px;
        height: 24px;
    }

    .copy-btn:hover {
        opacity: 0.9;
    }

    .copy-btn.copied {
        background: var(--warning);
        color: var(--text);
    }

    /* Receipt number styling */
    .receipt-number {
        font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
        font-size: 12px;
        font-weight: 500;
        color: #1f2937;
    }

    /* Scrollbar styling */
    ::-webkit-scrollbar {
        width: 6px;
        height: 6px;
    }

    ::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8;
    }

    /* Responsive */
    @media (max-width: 768px) {
        html, body {
            padding: 4px;
        }
        
        .container {
            padding: 8px;
        }
        
        .file-section {
            flex-direction: column;
            align-items: stretch;
            gap: 8px;
        }
        
        .file-input-container {
            flex-direction: column;
            align-items: stretch;
        }
        
        .file-name {
            text-align: center;
        }
        
        .search-box {
            max-width: none;
        }
        
        table {
            min-width: 350px;
        }
    }

    @media (max-width: 480px) {
        .button-group {
            justify-content: center;
        }
        
        .btn {
            flex: 1;
            min-width: 80px;
            justify-content: center;
        }
        
        .filter-container {
            justify-content: center;
        }
        
        .search-container {
            flex-direction: column;
            align-items: stretch;
        }
        
        .search-box, .search-btn, .clear-search {
            width: 100%;
            max-width: none;
        }
        
        th:nth-child(1), td:nth-child(1) {
            width: 40%;
        }
        
        th:nth-child(2), td:nth-child(2) {
            width: 35%;
        }
        
        th:nth-child(3), td:nth-child(3) {
            width: 25%;
        }
        
        .sales-type-badge {
            min-width: 60px;
            padding: 2px 6px;
            font-size: 10px;
        }
    }
</style>
</head>
<body>
<div class="container">
    <h1>Survey Link Generator</h1>
    
    <div class="file-section">
        <div class="file-input-container">
            <label for="fileInput" class="file-label">üìÅ Choose Excel File</label>
            <input type="file" id="fileInput" accept=".xlsx, .xls">
            <div class="file-name" id="fileName">No file chosen</div>
        </div>
        <div class="button-group">
            <button class="btn btn-primary" id="generateBtn" onclick="processFile()" disabled>Generate</button>
            <button class="btn btn-warning" onclick="clearData()">Clear</button>
        </div>
    </div>
    
    <div id="status" class="status" style="display: none;"></div>
    
    <div class="button-group">
        <button class="btn btn-success" id="copyAllBtn" onclick="copyAllLinks()" disabled>Copy All Links</button>
        <button class="btn btn-info" id="openQRBtn" onclick="openQRModal()" disabled>QR Codes</button>
    </div>
    
    <!-- Sales Type Filters -->
    <div class="filter-container" id="salesTypeFilters" style="display: none;">
        <button class="filter-btn active" data-type="all">All</button>
        <button class="filter-btn" data-type="DINE-IN">Dine-in</button>
        <button class="filter-btn" data-type="TAKEAWAY">Takeaway</button>
        <button class="filter-btn" data-type="DELIVERY">Delivery</button>
    </div>
    
    <!-- Search Box -->
    <div class="search-container">
        <input type="text" id="searchBox" class="search-box" placeholder="Search by Receipt No." disabled>
        <button class="search-btn" id="searchBtn" onclick="searchOrderId()" disabled>Search</button>
        <button class="clear-search" id="clearSearchBtn" onclick="clearSearch()" disabled>Clear</button>
    </div>
    
    <div class="table-container">
        <table id="linkTable">
            <thead>
                <tr>
                    <th>Receipt No.</th>
                    <th>Sales Type</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<!-- QR Code Modal -->
<div class="qr-modal" id="qrModal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; padding: 12px;">
    <div style="background: white; border-radius: 8px; padding: 16px; max-width: 400px; width: 100%;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <h2 style="margin: 0; font-size: 14px; font-weight: 600;">QR Code</h2>
            <button onclick="closeQRModal()" style="background: none; border: 1px solid #e5e7eb; border-radius: 6px; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 12px;">‚úï</button>
        </div>
        <div id="qrDisplay" style="display: flex; flex-direction: column; align-items: center; gap: 8px; padding: 12px; background: #f8fafc; border-radius: 8px; border: 1px solid #e5e7eb;"></div>
        <div style="display: flex; justify-content: center; gap: 8px; margin-top: 12px;">
            <button onclick="prevQR()" style="padding: 6px 12px; border: 1px solid #e5e7eb; background: white; border-radius: 6px; font-size: 12px; cursor: pointer;">Previous</button>
            <span id="qrCounter" style="font-size: 12px; font-weight: 500; padding: 6px 12px; background: #f3f4f6; border-radius: 4px;">1 / 0</span>
            <button onclick="nextQR()" style="padding: 6px 12px; border: 1px solid #e5e7eb; background: white; border-radius: 6px; font-size: 12px; cursor: pointer;">Next</button>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>
<script>
let currentData = [];
let filteredData = [];
let currentQRData = [];
let currentQRIndex = 0;
const storeID = "91KDIPL540-01";

// Initialize file input functionality
document.getElementById('fileInput').addEventListener('change', function(e) {
    const fileName = e.target.files[0] ? e.target.files[0].name : 'No file chosen';
    document.getElementById('fileName').textContent = fileName;
    document.getElementById('generateBtn').disabled = !e.target.files[0];
});

// Excel date/time converters
function convertExcelDate(serial) {
    const date = new Date((serial - 25569) * 86400 * 1000);
    return `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}`;
}

function convertExcelTime(serial) {
    const totalMilliseconds = Math.round(serial * 24 * 60 * 60 * 1000);
    const hours = String(Math.floor(totalMilliseconds / (60 * 60 * 1000))).padStart(2,'0');
    const minutes = String(Math.floor((totalMilliseconds % (60 * 60 * 1000)) / (60 * 1000))).padStart(2,'0');
    const seconds = String(Math.floor((totalMilliseconds % (60 * 1000)) / 1000)).padStart(2,'0');
    const milliseconds = String(totalMilliseconds % 1000).padStart(3,'0');
    return `${hours}:${minutes}:${seconds}.${milliseconds}`;
}

// Generate survey link
function generateSurveyLink(row) {
    const receiptNo = row['Receipt No.'];
    const salesType = row['Sales Type'];
    let surveyModel = '', orderID = '', numericOT = '';

    if (/^\d+$/.test(receiptNo) && salesType === 'TAKEAWAY') { surveyModel = '6.0'; orderID = receiptNo; numericOT = '2'; }
    else if (/^\d+$/.test(receiptNo) && salesType === 'DINE-IN') { surveyModel = '6.0'; orderID = receiptNo; numericOT = '1'; }
    else if (receiptNo.startsWith('K214') && salesType === 'TAKEAWAY') { surveyModel = '4.0'; orderID = receiptNo.slice(-4); numericOT = '2'; }
    else if (receiptNo.startsWith('K214') && salesType === 'DINE-IN') { surveyModel = '4.0'; orderID = receiptNo.slice(-4); numericOT = '1'; }
    else if (receiptNo.startsWith('K214') && salesType === 'DELIVERY') { surveyModel = '3.0'; orderID = receiptNo; numericOT = '3'; }
    else { return null; }

    const date = convertExcelDate(row['Date']);
    const time = convertExcelTime(row['Time']);
    const phoneNumber = `91${row['Sell-to Contact No.']}`;
    const isoDateTime = `${date}T${time}Z`;

    const data = { "S": storeID, "OI": orderID, "D": date, "TM": time, "DTM": isoDateTime, "TI": orderID, "OT": numericOT, "SM": surveyModel, "PH": phoneNumber };
    const encodedData = btoa(JSON.stringify(data));
    return `https://customer.kfc-listens.com/jfe/form/SV_8bHC0noyvM3jPWC?Q_EED=${encodedData}`;
}

// Show status message
function showStatus(message, type) {
    const statusDiv = document.getElementById('status');
    statusDiv.textContent = message;
    statusDiv.className = `status ${type}`;
    statusDiv.style.display = 'block';
    
    if (type === 'success') {
        setTimeout(() => {
            statusDiv.style.display = 'none';
        }, 3000);
    }
}

// Process uploaded file
function processFile() {
    const file = document.getElementById('fileInput').files[0];
    if (!file) return showStatus('Please select a file first', 'error');
    showStatus('Processing file...', 'success');

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
            const sheetData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
            const filteredData = sheetData.filter(row => !(row['POS Receipt No.']||'').match(/K214SWG|K214ZMT|K214MAGIC/));

            currentData = [];
            const tbody = document.querySelector('#linkTable tbody');
            tbody.innerHTML = '';

            let processedCount = 0;
            filteredData.forEach((row, index) => {
                const link = generateSurveyLink(row);
                if (link) {
                    processedCount++;
                    const linkData = {
                        receiptNo: row['Receipt No.'],
                        salesType: row['Sales Type'],
                        surveyModel: link.includes('SM=6.0') ? '6.0' : link.includes('SM=4.0') ? '4.0' : link.includes('SM=3.0') ? '3.0' : 'Unknown',
                        link: link,
                        copied: false
                    };
                    currentData.push(linkData);
                }
            });

            // Display all data initially
            displayData(currentData);
            setupSalesTypeFilters();

            showStatus(`Processed ${processedCount} records`, 'success');
            document.getElementById('copyAllBtn').disabled = false;
            document.getElementById('openQRBtn').disabled = false;
            
            // Enable search functionality
            document.getElementById('searchBox').disabled = false;
            document.getElementById('searchBtn').disabled = false;
            document.getElementById('clearSearchBtn').disabled = false;
            
            // Show sales type filters
            document.getElementById('salesTypeFilters').style.display = 'flex';
            
            // Generate QR codes
            generateQRCodes(currentData);
        } catch (err) {
            showStatus('Error: ' + err.message, 'error');
        }
    };
    reader.readAsArrayBuffer(file);
}

// Display data in table (3 columns only)
function displayData(data) {
    const tbody = document.querySelector('#linkTable tbody');
    tbody.innerHTML = '';

    data.forEach((linkData, index) => {
        const tr = document.createElement('tr');
        
        // Determine badge class based on sales type
        let badgeClass = '';
        if (linkData.salesType === 'DINE-IN') badgeClass = 'badge-dinein';
        else if (linkData.salesType === 'TAKEAWAY') badgeClass = 'badge-takeaway';
        else if (linkData.salesType === 'DELIVERY') badgeClass = 'badge-delivery';
        
        tr.innerHTML = `
            <td><span class="receipt-number">${linkData.receiptNo}</span></td>
            <td><span class="sales-type-badge ${badgeClass}">${linkData.salesType}</span></td>
            <td>
                <div class="action-buttons">
                    <button class="copy-btn" data-index="${index}" title="Copy survey link">Copy</button>
                </div>
            </td>
        `;
        tbody.appendChild(tr);
    });

    // Add event listeners to all copy buttons
    document.querySelectorAll('.copy-btn').forEach(button => {
        button.addEventListener('click', function() {
            const index = parseInt(this.getAttribute('data-index'));
            copyIndividualLink(index, this);
        });
    });
}

// Get badge class for sales type
function getBadgeClass(salesType) {
    switch(salesType) {
        case 'DINE-IN': return 'badge-dinein';
        case 'TAKEAWAY': return 'badge-takeaway';
        case 'DELIVERY': return 'badge-delivery';
        default: return '';
    }
}

// Copy individual link
function copyIndividualLink(index, button) {
    const dataToUse = filteredData.length > 0 ? filteredData : currentData;
    const linkData = dataToUse[index];
    
    if (linkData.copied) return;
    
    const link = linkData.link;
    navigator.clipboard.writeText(link).then(() => {
        linkData.copied = true;
        button.classList.add('copied');
        button.disabled = true;
        button.textContent = 'Copied!';
        showStatus(`Copied link for receipt ${linkData.receiptNo}`, 'success');
        
        // Reset button after 2 seconds
        setTimeout(() => {
            button.classList.remove('copied');
            button.disabled = false;
            button.textContent = 'Copy';
        }, 2000);
    }).catch(err => {
        showStatus('Copy failed: ' + err.message, 'error');
    });
}

// Copy all links
function copyAllLinks() {
    if (currentData.length === 0) {
        showStatus('No data to copy', 'error');
        return;
    }
    
    const allLinks = currentData.map(item => item.link).join('\n');
    navigator.clipboard.writeText(allLinks).then(() => {
        showStatus(`Copied ${currentData.length} links to clipboard`, 'success');
    }).catch(err => {
        showStatus('Copy failed: ' + err.message, 'error');
    });
}

// Search by Receipt No.
function searchOrderId() {
    const searchTerm = document.getElementById('searchBox').value.trim();
    
    if (!searchTerm) {
        showStatus('Please enter a search term', 'error');
        return;
    }
    
    filteredData = currentData.filter(item => 
        item.receiptNo.toLowerCase().includes(searchTerm.toLowerCase())
    );
    
    if (filteredData.length === 0) {
        showStatus('No matching records found', 'error');
        return;
    }
    
    displayData(filteredData);
    showStatus(`Found ${filteredData.length} matching records`, 'success');
}

// Clear search
function clearSearch() {
    document.getElementById('searchBox').value = '';
    filteredData = [];
    displayData(currentData);
    showStatus('Showing all records', 'success');
}

// Setup sales type filters
function setupSalesTypeFilters() {
    document.querySelectorAll('#salesTypeFilters .filter-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('#salesTypeFilters .filter-btn').forEach(b => {
                b.classList.remove('active');
            });
            this.classList.add('active');
            
            const type = this.getAttribute('data-type');
            
            if (type === 'all') {
                displayData(currentData);
                showStatus('Showing all records', 'success');
            } else {
                const filtered = currentData.filter(item => item.salesType === type);
                displayData(filtered);
                showStatus(`Showing ${filtered.length} ${type.toLowerCase()} records`, 'success');
            }
        });
    });
}

// Clear all data
function clearData() {
    currentData = [];
    filteredData = [];
    document.querySelector('#linkTable tbody').innerHTML = '';
    document.getElementById('fileName').textContent = 'No file chosen';
    document.getElementById('fileInput').value = '';
    document.getElementById('searchBox').value = '';
    document.getElementById('status').style.display = 'none';
    document.getElementById('copyAllBtn').disabled = true;
    document.getElementById('openQRBtn').disabled = true;
    document.getElementById('generateBtn').disabled = true;
    document.getElementById('searchBox').disabled = true;
    document.getElementById('searchBtn').disabled = true;
    document.getElementById('clearSearchBtn').disabled = true;
    document.getElementById('salesTypeFilters').style.display = 'none';
    showStatus('All data cleared', 'success');
}

// QR Code functions
function generateQRCodes(data) {
    currentQRData = data;
    currentQRIndex = 0;
}

function showQRCode(index) {
    const qrDisplay = document.getElementById('qrDisplay');
    qrDisplay.innerHTML = '';
    
    if (currentQRData.length === 0) {
        qrDisplay.innerHTML = '<div style="text-align:center; padding: 20px; color: #6b7280;">No QR codes to display</div>';
        document.getElementById('qrCounter').textContent = '0 / 0';
        return;
    }
    
    const item = currentQRData[index];
    const qr = qrcode(0, 'L');
    qr.addData(item.link);
    qr.make();
    
    const qrCodeDiv = document.createElement('div');
    qrCodeDiv.style.width = '200px';
    qrCodeDiv.style.height = '200px';
    qrCodeDiv.style.display = 'flex';
    qrCodeDiv.style.alignItems = 'center';
    qrCodeDiv.style.justifyContent = 'center';
    qrCodeDiv.style.background = 'white';
    qrCodeDiv.style.borderRadius = '6px';
    qrCodeDiv.style.border = '1px solid #e5e7eb';
    qrCodeDiv.innerHTML = qr.createSvgTag();
    
    const infoDiv = document.createElement('div');
    infoDiv.style.textAlign = 'center';
    infoDiv.style.fontSize = '12px';
    infoDiv.style.color = '#374151';
    infoDiv.innerHTML = `
        <div><strong>Receipt:</strong> ${item.receiptNo}</div>
        <div><strong>Type:</strong> <span class="sales-type-badge ${getBadgeClass(item.salesType)}">${item.salesType}</span></div>
    `;
    
    qrDisplay.appendChild(qrCodeDiv);
    qrDisplay.appendChild(infoDiv);
    
    document.getElementById('qrCounter').textContent = `${index + 1} / ${currentQRData.length}`;
    
    // Make QR code clickable
    qrCodeDiv.style.cursor = 'pointer';
    qrCodeDiv.onclick = () => window.open(item.link, '_blank');
}

function openQRModal() {
    if (currentQRData.length === 0) {
        showStatus('No QR codes to display', 'error');
        return;
    }
    
    document.getElementById('qrModal').style.display = 'flex';
    showQRCode(currentQRIndex);
}

function closeQRModal() {
    document.getElementById('qrModal').style.display = 'none';
}

function prevQR() {
    if (currentQRData.length === 0) return;
    currentQRIndex = (currentQRIndex - 1 + currentQRData.length) % currentQRData.length;
    showQRCode(currentQRIndex);
}

function nextQR() {
    if (currentQRData.length === 0) return;
    currentQRIndex = (currentQRIndex + 1) % currentQRData.length;
    showQRCode(currentQRIndex);
}

// Close modal on ESC key
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && document.getElementById('qrModal').style.display === 'flex') {
        closeQRModal();
    }
});

// Close modal when clicking outside
document.getElementById('qrModal').addEventListener('click', (e) => {
    if (e.target === document.getElementById('qrModal')) {
        closeQRModal();
    }
});

// Initialize filters on load
document.addEventListener('DOMContentLoaded', () => {
    setupSalesTypeFilters();
});
</script>
</body>
</html>
