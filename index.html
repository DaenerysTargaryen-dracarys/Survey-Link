<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Survey Link Generator</title>
<!--
  UI-only update: compact & friendly redesign.
  No JavaScript, logic, IDs or data attributes were changed.
  Replace only styling and a few purely-presentational layout choices.
-->
<style>
    /* Compact, modern, friendly UI ‚Äî minimal visual noise */
    :root{
        --bg: #f6f8fa;
        --card: #ffffff;
        --muted: #6b7280;
        --primary: #2563eb;
        --accent: #10b981;
        --warn: #f59e0b;
        --danger: #ef4444;
        --border: #e6e9ee;
        --radius: 10px;
        --shadow: 0 6px 18px rgba(15,23,42,0.06);
        --glass: rgba(255,255,255,0.6);
        --maxw: 980px;
    }

    /* Base */
    html,body{
        height:100%;
        margin:0;
        padding:12px;
        background: var(--bg);
        font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
        color:#0f172a;
        -webkit-font-smoothing:antialiased;
        -moz-osx-font-smoothing:grayscale;
        font-size:14px;
        line-height:1.4;
    }

    /* Container */
    .container{
        max-width:var(--maxw);
        margin:8px auto;
        background:var(--card);
        padding:14px;
        border-radius:var(--radius);
        box-shadow:var(--shadow);
        border:1px solid var(--border);
        box-sizing:border-box;
    }

    /* Header */
    h1{
        margin:0 0 12px 0;
        font-size:20px;
        font-weight:600;
        text-align:center;
        color:var(--primary);
        letter-spacing:0.2px;
    }

    /* Compact file section */
    .file-section{
        display:flex;
        gap:12px;
        align-items:center;
        justify-content:space-between;
        padding:10px;
        border-radius:8px;
        background: linear-gradient(180deg, rgba(16,185,129,0.04), transparent);
        border:1px solid var(--border);
    }

    .file-input-container{
        display:flex;
        gap:10px;
        align-items:center;
    }

    .file-label{
        display:inline-flex;
        align-items:center;
        gap:8px;
        padding:8px 12px;
        border-radius:8px;
        background:var(--primary);
        color:white;
        font-weight:600;
        font-size:13px;
        border:none;
        cursor:pointer;
    }

    input[type="file"]{ display:none; }

    .file-name{
        font-size:13px;
        color:var(--muted);
        max-width:420px;
        overflow:hidden;
        text-overflow:ellipsis;
        white-space:nowrap;
        background:transparent;
        padding:6px 8px;
        border-radius:6px;
        border:1px dashed var(--border);
    }

    /* Button group (compact) */
    .button-group{
        display:flex;
        gap:8px;
        flex-wrap:wrap;
        align-items:center;
    }

    .btn{
        padding:8px 12px;
        border-radius:8px;
        border:1px solid transparent;
        cursor:pointer;
        font-size:13px;
        font-weight:600;
        display:inline-flex;
        align-items:center;
        gap:8px;
        transition:all 0.12s ease;
        min-height:36px;
    }

    .btn:active{ transform:translateY(1px); }

    .btn-primary{
        background:var(--primary);
        color:white;
        box-shadow:none;
    }
    .btn-success{
        background:var(--accent);
        color:white;
    }
    .btn-warning{
        background:var(--warn);
        color:white;
    }
    .btn-info{
        background:#7c3aed;
        color:white;
    }
    .btn:disabled{
        opacity:0.6;
        cursor:not-allowed;
    }

    /* Status */
    .status{
        display:flex;
        align-items:center;
        justify-content:center;
        gap:10px;
        margin:12px 0;
        padding:8px 12px;
        border-radius:8px;
        font-weight:600;
        font-size:13px;
        border:1px solid var(--border);
    }
    .status.success{ background:rgba(34,197,94,0.06); color:#065f46; border-color: rgba(34,197,94,0.12) }
    .status.error{ background:rgba(239,68,68,0.06); color:#7f1d1d; border-color: rgba(239,68,68,0.12) }

    /* Filters & Search - compact */
    .filter-container{
        display:flex;
        gap:8px;
        margin:12px 0;
        flex-wrap:wrap;
    }
    .filter-btn{
        padding:6px 10px;
        border-radius:8px;
        background:#fff;
        border:1px solid var(--border);
        cursor:pointer;
        font-weight:600;
        font-size:13px;
    }
    .filter-btn.active{
        background:var(--primary);
        color:white;
        border-color:transparent;
    }

    .search-container{
        display:flex;
        gap:8px;
        align-items:center;
        margin:8px 0;
        flex-wrap:wrap;
    }
    .search-box{
        padding:8px 10px;
        border:1px solid var(--border);
        border-radius:8px;
        width:260px;
        font-size:13px;
    }
    .search-btn, .clear-search{
        padding:8px 10px;
        border-radius:8px;
        font-size:13px;
        border:1px solid var(--border);
        background:white;
    }

    /* Table: denser rows, compact paddings */
    .table-container{
        margin-top:10px;
        border-radius:8px;
        overflow:auto;
        border:1px solid var(--border);
    }
    table{
        width:100%;
        border-collapse:collapse;
        font-size:13px;
        min-width:680px;
    }
    thead th{
        position:sticky;
        top:0;
        background:#ffffff;
        padding:10px 12px;
        text-align:left;
        font-weight:700;
        border-bottom:1px solid var(--border);
        font-size:12px;
        color:var(--muted);
    }
    tbody td{
        padding:8px 12px;
        border-bottom:1px solid var(--border);
        color:#0f172a;
    }
    tbody tr:hover{ background: rgba(37,99,235,0.03); }

    /* Copy button small */
    .copy-btn{
        padding:6px 10px;
        border-radius:6px;
        background:var(--accent);
        color:white;
        border:1px solid transparent;
        font-size:12px;
    }
    .copy-btn.copied{
        background:var(--warn);
        color:#111827;
    }

    /* QR Modal compact */
    .qr-modal{
        display:none;
        position:fixed;
        inset:0;
        background:rgba(2,6,23,0.6);
        z-index:1000;
        align-items:center;
        justify-content:center;
        padding:12px;
    }
    .qr-modal-content{
        width:720px;
        max-width:100%;
        background:var(--card);
        border-radius:12px;
        padding:16px;
        border:1px solid var(--border);
        box-shadow:var(--shadow);
    }
    .qr-modal-header{ display:flex; justify-content:space-between; align-items:center; gap:12px; }
    .qr-modal-title{ margin:0; font-size:16px; color:var(--primary); font-weight:700; }

    .close-modal{
        background:transparent;
        border:1px solid var(--border);
        padding:6px 8px;
        border-radius:8px;
        cursor:pointer;
    }

    .qr-display{ width:260px; height:300px; border:1px solid var(--border); border-radius:8px; display:flex; align-items:center; justify-content:center; margin:12px 0; }
    .qr-slides{ display:flex; transition:transform .2s ease; width:100%; }
    .qr-slide{ min-width:100%; display:flex; flex-direction:column; align-items:center; gap:8px; }

    .qr-code{ width:200px; height:200px; display:flex; align-items:center; justify-content:center; border-radius:8px; border:1px solid var(--border); background:white; }

    .qr-nav{ display:flex; gap:8px; justify-content:center; align-items:center; margin-top:8px; }
    .qr-nav-btn{ padding:6px 10px; border-radius:8px; border:1px solid var(--border); background:white; cursor:pointer; }

    .qr-counter{ font-size:13px; padding:6px 10px; background:#f3f4f6; border-radius:999px; border:1px solid var(--border); }

    /* Hide decorative elements from original (kept in markup for backward compatibility) */
    .comic-dots, .speech-bubble, h1:after, .file-section:before, .container:before { display:none !important; }

    /* Responsive */
    @media (max-width:720px){
        .file-section{ flex-direction:column; align-items:stretch; gap:10px; }
        .button-group{ justify-content:flex-start; }
        .search-box{ width:100%; }
        table{ min-width:600px; font-size:13px; }
        .qr-modal-content{ padding:12px; }
        .qr-display{ width:220px; height:260px; }
        .qr-code{ width:180px; height:180px; }
    }
</style>
</head>
<body>
<div class="container">
    <div class="comic-dots dot-1"></div>
    <div class="comic-dots dot-2"></div>
    <div class="comic-dots dot-3"></div>
    <div class="comic-dots dot-4"></div>
    
    <h1> Rangan Vaathiyar </h1>
    
    <div class="file-section">
        <div class="file-input-container">
            <label for="fileInput" class="file-label">üìÅ Choose Excel</label>
            <input type="file" id="fileInput" accept=".xlsx, .xls">
            <div class="file-name" id="fileName">No file chosen</div>
        </div>
        <div class="button-group">
            <button class="btn btn-primary" id="generateBtn" onclick="processFile()" disabled>Generate</button>
            <button class="btn btn-warning" onclick="clearData()">Clear</button>
        </div>
    </div>
    
    <div id="status" class="status" style="display: none;"></div>
    
    <div class="button-group" style="margin-top:8px;">
        <button class="btn btn-success" id="copyAllBtn" onclick="copyAllLinks()" disabled>Copy All</button>
        <button class="btn btn-primary" onclick="exportToCSV()" id="exportBtn" disabled>Export CSV</button>
        <button class="btn btn-info" id="openQRBtn" onclick="openQRModal()" disabled>QR Codes</button>
    </div>
    
    <!-- Sales Type Filters -->
    <div class="filter-container" id="salesTypeFilters" style="display: none; margin-top:12px;">
        <button class="filter-btn active" data-type="all">All</button>
        <button class="filter-btn" data-type="DINE-IN">Dine-in</button>
        <button class="filter-btn" data-type="TAKEAWAY">Takeaway</button>
        <button class="filter-btn" data-type="DELIVERY">Delivery</button>
    </div>
    
    <!-- Search Box -->
    <div class="search-container" style="margin-top:8px;">
        <input type="text" id="searchBox" class="search-box" placeholder="Search by Order ID (e.g., 5031)" disabled>
        <button class="search-btn" id="searchBtn" onclick="searchOrderId()" disabled>Search</button>
        <button class="clear-search" id="clearSearchBtn" onclick="clearSearch()" disabled>Clear</button>
    </div>
    
    <div class="table-container">
        <table id="linkTable" aria-describedby="A compact table of generated survey links">
            <thead>
                <tr>
                    <th style="width:18%;">Receipt No.</th>
                    <th style="width:16%;">Sales Type</th>
                    <th style="width:12%;">Survey Model</th>
                    <th style="width:44%;">Generated Link</th>
                    <th style="width:10%;">Action</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<!-- QR Code Modal -->
<div class="qr-modal" id="qrModal">
    <div class="qr-modal-content">
        <div class="qr-modal-header">
            <h2 class="qr-modal-title">QR Codes</h2>
            <button class="close-modal" onclick="closeQRModal()">‚úï</button>
        </div>
        
        <!-- QR Code Filters -->
        <div class="filter-container" id="qrFilters">
            <button class="filter-btn active" data-type="all">All</button>
            <button class="filter-btn" data-type="DINE-IN">Dine-in</button>
            <button class="filter-btn" data-type="TAKEAWAY">Takeaway</button>
            <button class="filter-btn" data-type="DELIVERY">Delivery</button>
        </div>
        
        <div class="qr-container" style="display:flex; gap:12px; align-items:flex-start; flex-wrap:wrap;">
            <div style="flex:1; min-width:260px;">
                <div class="qr-display" id="qrDisplay">
                    <div class="qr-slides" id="qrSlides">
                        <!-- QR slides will be generated here -->
                    </div>
                </div>
                <div class="qr-nav">
                    <button class="qr-nav-btn" id="prevBtn" onclick="prevQR()">Previous</button>
                    <button class="qr-nav-btn" id="nextBtn" onclick="nextQR()">Next</button>
                </div>
            </div>
            <div style="width:220px; display:flex; flex-direction:column; gap:8px; align-items:center;">
                <div class="qr-counter" id="qrCounter">1 / 0</div>
                <div style="font-size:13px; color:var(--muted); text-align:center; padding:8px; border-radius:8px; border:1px solid var(--border); background:#fff;">
                    Use arrows to navigate ‚Ä¢ Tap QR to open in a new tab
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>
<script>
let currentData = [];
let filteredData = [];
let currentQRData = [];
let currentQRIndex = 0;
const storeID = "91KDIPL540-01"; // Store Code

// Excel date/time converters
function convertExcelDate(serial) {
    const date = new Date((serial - 25569) * 86400 * 1000);
    return `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}`;
}
function convertExcelTime(serial) {
    const totalMilliseconds = Math.round(serial * 24 * 60 * 60 * 1000);
    const hours = String(Math.floor(totalMilliseconds / (60 * 60 * 1000))).padStart(2,'0');
    const minutes = String(Math.floor((totalMilliseconds % (60 * 60 * 1000)) / (60 * 1000))).padStart(2,'0');
    const seconds = String(Math.floor((totalMilliseconds % (60 * 1000)) / 1000)).padStart(2,'0');
    const milliseconds = String(totalMilliseconds % 1000).padStart(3,'0');
    return `${hours}:${minutes}:${seconds}.${milliseconds}`;
}

// Generate link
function generateSurveyLink(row) {
    const receiptNo = row['Receipt No.'];
    const salesType = row['Sales Type'];
    let surveyModel = '', orderID = '', numericOT = '';

    if (/^\d+$/.test(receiptNo) && salesType === 'TAKEAWAY') { surveyModel = '6.0'; orderID = receiptNo; numericOT = '2'; }
    else if (/^\d+$/.test(receiptNo) && salesType === 'DINE-IN') { surveyModel = '6.0'; orderID = receiptNo; numericOT = '1'; }
    else if (receiptNo.startsWith('K214') && salesType === 'TAKEAWAY') { surveyModel = '4.0'; orderID = receiptNo.slice(-4); numericOT = '2'; }
    else if (receiptNo.startsWith('K214') && salesType === 'DINE-IN') { surveyModel = '4.0'; orderID = receiptNo.slice(-4); numericOT = '1'; }
    else if (receiptNo.startsWith('K214') && salesType === 'DELIVERY') { surveyModel = '3.0'; orderID = receiptNo; numericOT = '3'; }
    else { return null; }

    const date = convertExcelDate(row['Date']);
    const time = convertExcelTime(row['Time']);
    const phoneNumber = `91${row['Sell-to Contact No.']}`;
    const isoDateTime = `${date}T${time}Z`;

    const data = { "S": storeID, "OI": orderID, "D": date, "TM": time, "DTM": isoDateTime, "TI": orderID, "OT": numericOT, "SM": surveyModel, "PH": phoneNumber };
    const encodedData = btoa(JSON.stringify(data));
    return `https://customer.kfc-listens.com/jfe/form/SV_8bHC0noyvM3jPWC?Q_EED=${encodedData}`;
}

// File processing
function processFile() {
    const file = document.getElementById('fileInput').files[0];
    if (!file) return showStatus('Please select a file first', 'error');
    showStatus('Processing file...', 'success');

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
            const sheetData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
            const filteredData = sheetData.filter(row => !(row['POS Receipt No.']||'').match(/K214SWG|K214ZMT|K214MAGIC/));

            currentData = [];
            const tbody = document.querySelector('#linkTable tbody');
            tbody.innerHTML = '';

            let processedCount = 0;
            filteredData.forEach((row, index) => {
                const link = generateSurveyLink(row);
                if (link) {
                    processedCount++;
                    const linkData = {
                        receiptNo: row['Receipt No.'],
                        salesType: row['Sales Type'],
                        surveyModel: link.includes('SM=6.0') ? '6.0' : link.includes('SM=4.0') ? '4.0' : link.includes('SM=3.0') ? '3.0' : 'Unknown',
                        link: link,
                        copied: false // Track if this link has been copied
                    };
                    currentData.push(linkData);
                }
            });

            // Display all data initially
            displayData(currentData);

            showStatus(`Processed ${processedCount} records`, 'success');
            document.getElementById('copyAllBtn').disabled = false;
            document.getElementById('exportBtn').disabled = false;
            document.getElementById('openQRBtn').disabled = false;
            
            // Enable search functionality
            document.getElementById('searchBox').disabled = false;
            document.getElementById('searchBtn').disabled = false;
            document.getElementById('clearSearchBtn').disabled = false;
            
            // Show sales type filters
            document.getElementById('salesTypeFilters').style.display = 'flex';
            
            // Generate QR codes for all data
            generateQRCodes(currentData);
        } catch (err) {
            showStatus('Error: ' + err.message, 'error');
        }
    };
    reader.readAsArrayBuffer(file);
}

// Display data in table
function displayData(data) {
    const tbody = document.querySelector('#linkTable tbody');
    tbody.innerHTML = '';

    data.forEach((linkData, index) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${linkData.receiptNo}</td>
            <td>${linkData.salesType}</td>
            <td>${linkData.surveyModel}</td>
            <td>${linkData.link}</td>
            <td><button class="copy-btn" data-index="${index}">Copy</button></td>
        `;
        tbody.appendChild(tr);
    });

    // Add event listeners to all copy buttons
    document.querySelectorAll('.copy-btn').forEach(button => {
        button.addEventListener('click', function() {
            const index = parseInt(this.getAttribute('data-index'));
            copyIndividualLink(index, this);
        });
    });
}

// Search by Order ID
function searchOrderId() {
    const searchTerm = document.getElementById('searchBox').value.trim();
    
    if (!searchTerm) {
        showStatus('Please enter a search term', 'error');
        return;
    }
    
    // Filter data based on search term
    filteredData = currentData.filter(item => 
        item.receiptNo.includes(searchTerm)
    );
    
    if (filteredData.length === 0) {
        showStatus('No matching records found', 'error');
        return;
    }
    
    // Display filtered data
    displayData(filteredData);
    
    showStatus(`Found ${filteredData.length} matching records`, 'success');
}

// Clear search and show all data
function clearSearch() {
    document.getElementById('searchBox').value = '';
    displayData(currentData);
    showStatus('Showing all records', 'success');
}

// Filter by sales type
function setupSalesTypeFilters() {
    document.querySelectorAll('#salesTypeFilters .filter-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            // Update active button
            document.querySelectorAll('#salesTypeFilters .filter-btn').forEach(b => {
                b.classList.remove('active');
            });
            this.classList.add('active');
            
            const type = this.getAttribute('data-type');
            
            if (type === 'all') {
                displayData(currentData);
                showStatus('Showing all records', 'success');
            } else {
                const filtered = currentData.filter(item => item.salesType === type);
                displayData(filtered);
                showStatus(`Showing ${filtered.length} ${type.toLowerCase()} records`, 'success');
            }
        });
    });
}

// Copy individual link
function copyIndividualLink(index, button) {
    const dataToUse = filteredData.length > 0 ? filteredData : currentData;
    const linkData = dataToUse[index];
    
    // If already copied, do nothing
    if (linkData.copied) {
        return;
    }
    
    const link = linkData.link;
    
    // Create a temporary textarea element
    const textArea = document.createElement("textarea");
    textArea.value = link;
    textArea.style.position = "fixed";
    textArea.style.left = "-999999px";
    textArea.style.top = "-999999px";
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
        const successful = document.execCommand('copy');
        if (successful) {
            // Mark as copied and disable the button
            linkData.copied = true;
            button.classList.add('copied');
            button.disabled = true;
            showStatus('Link copied to clipboard', 'success');
        } else {
            showStatus('Copy failed', 'error');
        }
    } catch (err) {
        showStatus('Copy error: ' + err.message, 'error');
    } finally {
        document.body.removeChild(textArea);
    }
}

// The rest of the original JavaScript (copyAllLinks, exportToCSV, QR generation, modal controls, helpers, etc.)
// remains unchanged and will continue to work with the compact UI.
</script>
</body>
</html>
