<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Survey Link Generator</title>
<style>
    body {
        font-family: 'Comic Sans MS', 'Marker Felt', 'Arial Rounded MT Bold', sans-serif;
        margin: 0;
        padding: 20px;
        background-color: #e6f2ff;
        background-image: radial-gradient(#b3d9ff 15%, transparent 16%),
                          radial-gradient(#b3d9ff 15%, transparent 16%);
        background-size: 40px 40px;
        background-position: 0 0, 20px 20px;
        color: #333;
    }
    .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        padding: 25px;
        border-radius: 15px;
        box-shadow: 8px 8px 0 #333, 15px 15px 0 #ffcc00;
        border: 4px solid #333;
        position: relative;
        overflow: hidden;
    }
    .container:before {
        content: "";
        position: absolute;
        top: -10px;
        left: -10px;
        right: -10px;
        bottom: -10px;
        border: 3px dashed #ff6600;
        border-radius: 20px;
        pointer-events: none;
        z-index: -1;
    }
    h1 {
        text-align: center;
        font-size: 36px;
        margin-bottom: 25px;
        color: #ff3300;
        text-shadow: 3px 3px 0 #ffcc00, 6px 6px 0 rgba(0,0,0,0.2);
        text-transform: uppercase;
        letter-spacing: 1px;
        position: relative;
        display: inline-block;
        left: 50%;
        transform: translateX(-50%);
        padding: 10px 30px;
        background: white;
        border: 4px solid #333;
        border-radius: 15px;
        box-shadow: 5px 5px 0 #333;
    }
    h1:after {
        content: "!!!";
        position: absolute;
        top: -20px;
        right: -20px;
        background: #ffcc00;
        color: #ff3300;
        font-size: 24px;
        padding: 5px 10px;
        border-radius: 50%;
        border: 3px solid #333;
        transform: rotate(15deg);
        animation: bounce 1s infinite alternate;
    }
    @keyframes bounce {
        from { transform: rotate(15deg) scale(1); }
        to { transform: rotate(15deg) scale(1.1); }
    }
    .file-section {
        text-align: center;
        margin: 25px 0;
        padding: 25px;
        border: 4px dashed #ff6600;
        border-radius: 15px;
        background-color: #fff9e6;
        position: relative;
        min-height: 120px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }
    .file-section:before {
        content: "üìÅ";
        position: absolute;
        top: -20px;
        left: 20px;
        font-size: 40px;
        background: white;
        padding: 5px;
        border: 3px solid #333;
        border-radius: 10px;
        transform: rotate(-10deg);
    }
    .file-input-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 15px;
        width: 100%;
        max-width: 400px;
    }
    .file-label {
        font-weight: bold;
        font-size: 18px;
        color: #333;
        background: #ffcc00;
        padding: 8px 15px;
        border-radius: 8px;
        border: 2px solid #333;
        box-shadow: 3px 3px 0 #333;
        cursor: pointer;
        transition: all 0.2s;
    }
    .file-label:hover {
        transform: translateY(-2px);
        box-shadow: 4px 4px 0 #333;
    }
    input[type="file"] {
        display: none;
    }
    .file-name {
        font-size: 16px;
        color: #666;
        background: white;
        padding: 8px 15px;
        border-radius: 8px;
        border: 2px solid #3399ff;
        max-width: 100%;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    .button-group {
        display: flex;
        gap: 15px;
        justify-content: center;
        margin: 25px 0;
        flex-wrap: wrap;
    }
    .btn {
        padding: 12px 25px;
        border: 3px solid #333;
        border-radius: 10px;
        cursor: pointer;
        font-size: 18px;
        font-weight: bold;
        font-family: 'Comic Sans MS', sans-serif;
        transition: all 0.2s;
        position: relative;
        text-transform: uppercase;
        letter-spacing: 1px;
        box-shadow: 4px 4px 0 #333;
    }
    .btn:hover {
        transform: translateY(-3px);
        box-shadow: 6px 6px 0 #333;
    }
    .btn:active {
        transform: translateY(1px);
        box-shadow: 2px 2px 0 #333;
    }
    .btn-primary { 
        background-color: #3399ff; 
        color: white; 
    }
    .btn-primary:hover { 
        background-color: #0077e6; 
    }
    .btn-success { 
        background-color: #33cc33; 
        color: white; 
    }
    .btn-success:hover { 
        background-color: #29a329; 
    }
    .btn-warning { 
        background-color: #ffcc00; 
        color: #333; 
    }
    .btn-warning:hover { 
        background-color: #e6b800; 
    }
    .btn-info { 
        background-color: #9933ff; 
        color: white; 
    }
    .btn-info:hover { 
        background-color: #7a29cc; 
    }
    .btn:disabled { 
        background-color: #cccccc; 
        color: #999;
        cursor: not-allowed; 
        box-shadow: 2px 2px 0 #999;
        border-color: #999;
    }
    .btn:disabled:hover {
        transform: none;
        box-shadow: 2px 2px 0 #999;
    }
    table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        margin-top: 25px;
        border: 4px solid #333;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 5px 5px 0 #333;
        background: white;
    }
    th, td {
        border-bottom: 3px solid #333;
        border-right: 3px solid #333;
        padding: 12px;
        text-align: left;
        vertical-align: middle;
    }
    th {
        background-color: #ff6600;
        color: white;
        position: sticky;
        top: 0;
        font-size: 18px;
        text-transform: uppercase;
        text-shadow: 2px 2px 0 rgba(0,0,0,0.2);
    }
    th:last-child, td:last-child {
        border-right: none;
    }
    tr:last-child td {
        border-bottom: none;
    }
    tr:nth-child(even) { 
        background-color: #fff0e6; 
    }
    tr:nth-child(odd) { 
        background-color: white; 
    }
    .copy-btn {
        background-color: #33cc99;
        color: white;
        border: 2px solid #333;
        padding: 8px 15px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: bold;
        font-family: 'Comic Sans MS', sans-serif;
        white-space: nowrap;
        position: relative;
        overflow: hidden;
        box-shadow: 2px 2px 0 #333;
        transition: all 0.2s;
    }
    .copy-btn:hover { 
        background-color: #29a37a; 
        transform: translateY(-2px);
        box-shadow: 3px 3px 0 #333;
    }
    .copy-btn:active {
        transform: translateY(1px);
        box-shadow: 1px 1px 0 #333;
    }
    .copy-btn.copied {
        background-color: #ff3333 !important;
        cursor: not-allowed;
        animation: wiggle 0.5s;
    }
    .copy-btn:disabled {
        background-color: #999999 !important;
        color: #666;
        cursor: not-allowed;
        box-shadow: 1px 1px 0 #666;
        border-color: #666;
        transform: none;
    }
    @keyframes wiggle {
        0%, 100% { transform: rotate(0); }
        25% { transform: rotate(-5deg); }
        75% { transform: rotate(5deg); }
    }
    /* Hide Survey Model and Generated Link columns visually */
    th:nth-child(3), td:nth-child(3),
    th:nth-child(4), td:nth-child(4) {
        display: none;
    }
    .status {
        text-align: center;
        margin: 25px 0;
        padding: 15px;
        border-radius: 10px;
        border: 3px solid;
        font-weight: bold;
        font-size: 18px;
        box-shadow: 3px 3px 0 #333;
    }
    .status.success { 
        background-color: #ccffcc; 
        color: #006600; 
        border-color: #33cc33;
    }
    .status.error { 
        background-color: #ffcccc; 
        color: #cc0000; 
        border-color: #ff3333;
    }
    .table-container {
        max-height: 600px;
        overflow-y: auto;
        border: 4px solid #333;
        border-radius: 15px;
        box-shadow: 5px 5px 0 #333;
        background: white;
    }
    .comic-dots {
        position: absolute;
        width: 20px;
        height: 20px;
        background: #ffcc00;
        border: 3px solid #333;
        border-radius: 50%;
    }
    .dot-1 { top: 20px; left: 20px; }
    .dot-2 { top: 20px; right: 20px; }
    .dot-3 { bottom: 20px; left: 20px; }
    .dot-4 { bottom: 20px; right: 20px; }
    .speech-bubble {
        position: absolute;
        bottom: -40px;
        right: 30px;
        background: white;
        border: 3px solid #333;
        border-radius: 20px;
        padding: 10px 15px;
        font-weight: bold;
        box-shadow: 3px 3px 0 #333;
        transform: rotate(-5deg);
        animation: float 3s infinite ease-in-out;
    }
    .speech-bubble:after {
        content: "";
        position: absolute;
        bottom: -15px;
        right: 30px;
        border-width: 15px 10px 0;
        border-style: solid;
        border-color: white transparent;
        display: block;
        width: 0;
    }
    .speech-bubble:before {
        content: "";
        position: absolute;
        bottom: -18px;
        right: 29px;
        border-width: 16px 11px 0;
        border-style: solid;
        border-color: #333 transparent;
        display: block;
        width: 0;
    }
    @keyframes float {
        0%, 100% { transform: rotate(-5deg) translateY(0); }
        50% { transform: rotate(-5deg) translateY(-5px); }
    }

    /* Search Box Styles */
    .search-container {
        margin: 20px 0;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
    }
    .search-box {
        padding: 12px 15px;
        border: 3px solid #333;
        border-radius: 10px;
        font-size: 16px;
        font-family: 'Comic Sans MS', sans-serif;
        width: 300px;
        max-width: 100%;
        box-shadow: 3px 3px 0 #333;
        transition: all 0.2s;
    }
    .search-box:focus {
        outline: none;
        box-shadow: 5px 5px 0 #ffcc00;
        transform: translateY(-2px);
    }
    .search-btn {
        padding: 12px 20px;
        background-color: #ff6600;
        color: white;
        border: 3px solid #333;
        border-radius: 10px;
        cursor: pointer;
        font-size: 16px;
        font-weight: bold;
        font-family: 'Comic Sans MS', sans-serif;
        box-shadow: 3px 3px 0 #333;
        transition: all 0.2s;
    }
    .search-btn:hover {
        background-color: #e65c00;
        transform: translateY(-2px);
        box-shadow: 5px 5px 0 #333;
    }
    .search-btn:active {
        transform: translateY(1px);
        box-shadow: 2px 2px 0 #333;
    }
    .clear-search {
        padding: 12px 20px;
        background-color: #cccccc;
        color: #333;
        border: 3px solid #333;
        border-radius: 10px;
        cursor: pointer;
        font-size: 16px;
        font-weight: bold;
        font-family: 'Comic Sans MS', sans-serif;
        box-shadow: 3px 3px 0 #333;
        transition: all 0.2s;
    }
    .clear-search:hover {
        background-color: #b3b3b3;
        transform: translateY(-2px);
        box-shadow: 5px 5px 0 #333;
    }
    .clear-search:active {
        transform: translateY(1px);
        box-shadow: 2px 2px 0 #333;
    }

    /* Filter Styles */
    .filter-container {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin: 20px 0;
        flex-wrap: wrap;
    }
    .filter-btn {
        padding: 10px 20px;
        background-color: #99ccff;
        color: #333;
        border: 3px solid #333;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        font-weight: bold;
        font-family: 'Comic Sans MS', sans-serif;
        box-shadow: 3px 3px 0 #333;
        transition: all 0.2s;
    }
    .filter-btn:hover {
        transform: translateY(-2px);
        box-shadow: 5px 5px 0 #333;
    }
    .filter-btn.active {
        background-color: #3399ff;
        color: white;
    }

    /* QR Code Modal Styles */
    .qr-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        z-index: 1000;
        justify-content: center;
        align-items: center;
    }
    .qr-modal-content {
        background-color: white;
        padding: 30px;
        border-radius: 20px;
        border: 5px solid #333;
        box-shadow: 10px 10px 0 #333, 15px 15px 0 #ffcc00;
        max-width: 90%;
        max-height: 90%;
        overflow: auto;
        position: relative;
    }
    .qr-modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
        gap: 15px;
    }
    .qr-modal-title {
        font-size: 28px;
        color: #ff3300;
        text-shadow: 2px 2px 0 #ffcc00;
        margin: 0;
    }
    .close-modal {
        background-color: #ff3333;
        color: white;
        border: 3px solid #333;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        font-size: 20px;
        font-weight: bold;
        cursor: pointer;
        display: flex;
        justify-content: center;
        align-items: center;
        box-shadow: 3px 3px 0 #333;
        transition: all 0.2s;
    }
    .close-modal:hover {
        transform: translateY(-2px);
        box-shadow: 5px 5px 0 #333;
    }
    .qr-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 20px;
    }
    .qr-display {
        position: relative;
        width: 320px;
        height: 370px;
        overflow: hidden;
        border: 4px solid #333;
        border-radius: 15px;
        box-shadow: 5px 5px 0 #333;
        background: white;
        touch-action: pan-y;
    }
    .qr-slides {
        display: flex;
        transition: transform 0.3s ease;
        height: 100%;
        width: 100%;
    }
    .qr-slide {
        min-width: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 20px;
        text-align: center;
        box-sizing: border-box;
    }
    .qr-code {
        width: 220px;
        height: 220px;
        margin-bottom: 15px;
        display: flex;
        justify-content: center;
        align-items: center;
        background: white;
        border: 2px solid #333;
        border-radius: 10px;
        padding: 10px;
        box-sizing: border-box;
    }
    .qr-code img {
        max-width: 100%;
        max-height: 100%;
        display: block;
    }
    .qr-info {
        font-size: 16px;
        font-weight: bold;
        margin-bottom: 10px;
        background: #fff9e6;
        padding: 8px 15px;
        border-radius: 10px;
        border: 2px solid #333;
        width: 100%;
        box-sizing: border-box;
    }
    .qr-nav {
        display: flex;
        justify-content: space-between;
        width: 100%;
        margin-top: 10px;
    }
    .qr-nav-btn {
        padding: 8px 15px;
        background-color: #ffcc00;
        color: #333;
        border: 3px solid #333;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: bold;
        font-family: 'Comic Sans MS', sans-serif;
        box-shadow: 3px 3px 0 #333;
        transition: all 0.2s;
    }
    .qr-nav-btn:hover {
        transform: translateY(-2px);
        box-shadow: 5px 5px 0 #333;
    }
    .qr-nav-btn:active {
        transform: translateY(1px);
        box-shadow: 2px 2px 0 #333;
    }
    .qr-nav-btn:disabled {
        background-color: #cccccc;
        color: #999;
        cursor: not-allowed;
        box-shadow: 2px 2px 0 #999;
        border-color: #999;
    }
    .qr-counter {
        font-weight: bold;
        font-size: 16px;
        margin-top: 10px;
        background: #3399ff;
        color: white;
        padding: 5px 15px;
        border-radius: 20px;
        border: 2px solid #333;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        .container {
            padding: 15px;
        }
        h1 {
            font-size: 28px;
            padding: 8px 20px;
        }
        .file-section {
            padding: 20px 15px;
        }
        .button-group {
            flex-direction: column;
            align-items: center;
        }
        .btn {
            width: 100%;
            max-width: 300px;
        }
        table {
            font-size: 14px;
        }
        th, td {
            padding: 8px;
        }
        .search-container {
            flex-direction: column;
        }
        .search-box {
            width: 100%;
        }
        .filter-container {
            flex-direction: column;
            align-items: center;
        }
        .filter-btn {
            width: 100%;
            max-width: 200px;
        }
        .qr-modal-content {
            padding: 20px;
        }
        .qr-display {
            width: 280px;
            height: 330px;
        }
        .qr-code {
            width: 200px;
            height: 200px;
        }
    }
</style>
</head>
<body>
<div class="container">
    <div class="comic-dots dot-1"></div>
    <div class="comic-dots dot-2"></div>
    <div class="comic-dots dot-3"></div>
    <div class="comic-dots dot-4"></div>
    
    <h1>Survey Link Generator</h1>
    
    <div class="file-section">
        <div class="file-input-container">
            <label for="fileInput" class="file-label">üìÅ CHOOSE EXCEL FILE</label>
            <input type="file" id="fileInput" accept=".xlsx, .xls">
            <div class="file-name" id="fileName">No file chosen</div>
        </div>
        <div class="button-group">
            <button class="btn btn-primary" id="generateBtn" onclick="processFile()" disabled>Generate Links</button>
            <button class="btn btn-warning" onclick="clearData()">Clear All</button>
        </div>
    </div>
    
    <div id="status" class="status" style="display: none;"></div>
    
    <div class="button-group">
        <button class="btn btn-success" id="copyAllBtn" onclick="copyAllLinks()" disabled>Copy All Links</button>
        <button class="btn btn-primary" onclick="exportToCSV()" id="exportBtn" disabled>Export to CSV</button>
        <button class="btn btn-info" id="openQRBtn" onclick="openQRModal()" disabled>Open QR Codes</button>
        <div class="speech-bubble">Click me!</div>
    </div>
    
    <!-- Sales Type Filters -->
    <div class="filter-container" id="salesTypeFilters" style="display: none;">
        <button class="filter-btn active" data-type="all">All</button>
        <button class="filter-btn" data-type="DINE-IN">Dine-in</button>
        <button class="filter-btn" data-type="TAKEAWAY">Takeaway</button>
        <button class="filter-btn" data-type="DELIVERY">Delivery</button>
    </div>
    
    <!-- Search Box -->
    <div class="search-container">
        <input type="text" id="searchBox" class="search-box" placeholder="Search by Order ID (e.g., 5031)" disabled>
        <button class="search-btn" id="searchBtn" onclick="searchOrderId()" disabled>Search</button>
        <button class="clear-search" id="clearSearchBtn" onclick="clearSearch()" disabled>Clear Search</button>
    </div>
    
    <div class="table-container">
        <table id="linkTable">
            <thead>
                <tr>
                    <th>Receipt No.</th>
                    <th>Sales Type</th>
                    <th>Survey Model</th>
                    <th>Generated Link</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<!-- QR Code Modal -->
<div class="qr-modal" id="qrModal">
    <div class="qr-modal-content">
        <div class="qr-modal-header">
            <h2 class="qr-modal-title">QR Codes</h2>
            <button class="close-modal" onclick="closeQRModal()">‚úï</button>
        </div>
        
        <!-- QR Code Filters -->
        <div class="filter-container" id="qrFilters">
            <button class="filter-btn active" data-type="all">All</button>
            <button class="filter-btn" data-type="DINE-IN">Dine-in</button>
            <button class="filter-btn" data-type="TAKEAWAY">Takeaway</button>
            <button class="filter-btn" data-type="DELIVERY">Delivery</button>
        </div>
        
        <div class="qr-container">
            <div class="qr-display" id="qrDisplay">
                <div class="qr-slides" id="qrSlides">
                    <!-- QR slides will be generated here -->
                </div>
            </div>
            <div class="qr-nav">
                <button class="qr-nav-btn" id="prevBtn" onclick="prevQR()">Previous</button>
                <button class="qr-nav-btn" id="nextBtn" onclick="nextQR()">Next</button>
            </div>
            <div class="qr-counter" id="qrCounter">1 / 0</div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>
<script>
let currentData = [];
let filteredData = [];
let currentQRData = [];
let currentQRIndex = 0;
const storeID = "91KDIPL540-01"; // Store Code

// Excel date/time converters
function convertExcelDate(serial) {
    const date = new Date((serial - 25569) * 86400 * 1000);
    return `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}`;
}
function convertExcelTime(serial) {
    const totalMilliseconds = Math.round(serial * 24 * 60 * 60 * 1000);
    const hours = String(Math.floor(totalMilliseconds / (60 * 60 * 1000))).padStart(2,'0');
    const minutes = String(Math.floor((totalMilliseconds % (60 * 60 * 1000)) / (60 * 1000))).padStart(2,'0');
    const seconds = String(Math.floor((totalMilliseconds % (60 * 1000)) / 1000)).padStart(2,'0');
    const milliseconds = String(totalMilliseconds % 1000).padStart(3,'0');
    return `${hours}:${minutes}:${seconds}.${milliseconds}`;
}

// Generate link
function generateSurveyLink(row) {
    const receiptNo = row['Receipt No.'];
    const salesType = row['Sales Type'];
    let surveyModel = '', orderID = '', numericOT = '';

    if (/^\d+$/.test(receiptNo) && salesType === 'TAKEAWAY') { surveyModel = '6.0'; orderID = receiptNo; numericOT = '2'; }
    else if (/^\d+$/.test(receiptNo) && salesType === 'DINE-IN') { surveyModel = '6.0'; orderID = receiptNo; numericOT = '1'; }
    else if (receiptNo.startsWith('K214') && salesType === 'TAKEAWAY') { surveyModel = '4.0'; orderID = receiptNo.slice(-4); numericOT = '2'; }
    else if (receiptNo.startsWith('K214') && salesType === 'DINE-IN') { surveyModel = '4.0'; orderID = receiptNo.slice(-4); numericOT = '1'; }
    else if (receiptNo.startsWith('K214') && salesType === 'DELIVERY') { surveyModel = '3.0'; orderID = receiptNo; numericOT = '3'; }
    else { return null; }

    const date = convertExcelDate(row['Date']);
    const time = convertExcelTime(row['Time']);
    const phoneNumber = `91${row['Sell-to Contact No.']}`;
    const isoDateTime = `${date}T${time}Z`;

    const data = { "S": storeID, "OI": orderID, "D": date, "TM": time, "DTM": isoDateTime, "TI": orderID, "OT": numericOT, "SM": surveyModel, "PH": phoneNumber };
    const encodedData = btoa(JSON.stringify(data));
    return `https://customer.kfc-listens.com/jfe/form/SV_8bHC0noyvM3jPWC?Q_EED=${encodedData}`;
}

// File processing
function processFile() {
    const file = document.getElementById('fileInput').files[0];
    if (!file) return showStatus('Please select a file first', 'error');
    showStatus('Processing file...', 'success');

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
            const sheetData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
            const filteredData = sheetData.filter(row => !(row['POS Receipt No.']||'').match(/K214SWG|K214ZMT|K214MAGIC/));

            currentData = [];
            const tbody = document.querySelector('#linkTable tbody');
            tbody.innerHTML = '';

            let processedCount = 0;
            filteredData.forEach((row, index) => {
                const link = generateSurveyLink(row);
                if (link) {
                    processedCount++;
                    const linkData = {
                        receiptNo: row['Receipt No.'],
                        salesType: row['Sales Type'],
                        surveyModel: link.includes('SM=6.0') ? '6.0' : link.includes('SM=4.0') ? '4.0' : link.includes('SM=3.0') ? '3.0' : 'Unknown',
                        link: link,
                        copied: false // Track if this link has been copied
                    };
                    currentData.push(linkData);
                }
            });

            // Display all data initially
            displayData(currentData);

            showStatus(`Processed ${processedCount} records`, 'success');
            document.getElementById('copyAllBtn').disabled = false;
            document.getElementById('exportBtn').disabled = false;
            document.getElementById('openQRBtn').disabled = false;
            
            // Enable search functionality
            document.getElementById('searchBox').disabled = false;
            document.getElementById('searchBtn').disabled = false;
            document.getElementById('clearSearchBtn').disabled = false;
            
            // Show sales type filters
            document.getElementById('salesTypeFilters').style.display = 'flex';
            
            // Generate QR codes for all data
            generateQRCodes(currentData);
        } catch (err) {
            showStatus('Error: ' + err.message, 'error');
        }
    };
    reader.readAsArrayBuffer(file);
}

// Display data in table
function displayData(data) {
    const tbody = document.querySelector('#linkTable tbody');
    tbody.innerHTML = '';

    data.forEach((linkData, index) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${linkData.receiptNo}</td>
            <td>${linkData.salesType}</td>
            <td>${linkData.surveyModel}</td>
            <td>${linkData.link}</td>
            <td><button class="copy-btn" data-index="${index}">Copy</button></td>
        `;
        tbody.appendChild(tr);
    });

    // Add event listeners to all copy buttons
    document.querySelectorAll('.copy-btn').forEach(button => {
        button.addEventListener('click', function() {
            const index = parseInt(this.getAttribute('data-index'));
            copyIndividualLink(index, this);
        });
    });
}

// Search by Order ID
function searchOrderId() {
    const searchTerm = document.getElementById('searchBox').value.trim();
    
    if (!searchTerm) {
        showStatus('Please enter a search term', 'error');
        return;
    }
    
    // Filter data based on search term
    filteredData = currentData.filter(item => 
        item.receiptNo.includes(searchTerm)
    );
    
    if (filteredData.length === 0) {
        showStatus('No matching records found', 'error');
        return;
    }
    
    // Display filtered data
    displayData(filteredData);
    
    showStatus(`Found ${filteredData.length} matching records`, 'success');
}

// Clear search and show all data
function clearSearch() {
    document.getElementById('searchBox').value = '';
    displayData(currentData);
    showStatus('Showing all records', 'success');
}

// Filter by sales type
function setupSalesTypeFilters() {
    document.querySelectorAll('#salesTypeFilters .filter-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            // Update active button
            document.querySelectorAll('#salesTypeFilters .filter-btn').forEach(b => {
                b.classList.remove('active');
            });
            this.classList.add('active');
            
            const type = this.getAttribute('data-type');
            
            if (type === 'all') {
                displayData(currentData);
                showStatus('Showing all records', 'success');
            } else {
                const filtered = currentData.filter(item => item.salesType === type);
                displayData(filtered);
                showStatus(`Showing ${filtered.length} ${type.toLowerCase()} records`, 'success');
            }
        });
    });
}

// Copy individual link
function copyIndividualLink(index, button) {
    const dataToUse = filteredData.length > 0 ? filteredData : currentData;
    const linkData = dataToUse[index];
    
    // If already copied, do nothing
    if (linkData.copied) {
        return;
    }
    
    const link = linkData.link;
    
    // Create a temporary textarea element
    const textArea = document.createElement("textarea");
    textArea.value = link;
    textArea.style.position = "fixed";
    textArea.style.left = "-999999px";
    textArea.style.top = "-999999px";
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
        const successful = document.execCommand('copy');
        if (successful) {
            // Mark as copied and disable the button
            linkData.copied = true;
            button.textContent = 'Copied!';
            button.classList.add('copied');
            button.disabled = true;
            
            showStatus('Link copied to clipboard!', 'success');
        } else {
            showStatus('Failed to copy link', 'error');
        }
    } catch (err) {
        console.error('Fallback: Oops, unable to copy', err);
        showStatus('Failed to copy link', 'error');
    }
    
    document.body.removeChild(textArea);
}

// Copy all links
function copyAllLinks() {
    const dataToUse = filteredData.length > 0 ? filteredData : currentData;
    const links = dataToUse.map(item => item.link).join('\n');
    
    // Create a temporary textarea element
    const textArea = document.createElement("textarea");
    textArea.value = links;
    textArea.style.position = "fixed";
    textArea.style.left = "-999999px";
    textArea.style.top = "-999999px";
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
        const successful = document.execCommand('copy');
        if (successful) {
            // Mark all links as copied and disable all copy buttons
            dataToUse.forEach((item, index) => {
                item.copied = true;
            });
            
            document.querySelectorAll('.copy-btn').forEach(button => {
                button.textContent = 'Copied!';
                button.classList.add('copied');
                button.disabled = true;
            });
            
            showStatus('All links copied to clipboard!', 'success');
        } else {
            showStatus('Failed to copy all links', 'error');
        }
    } catch (err) {
        console.error('Fallback: Oops, unable to copy', err);
        showStatus('Failed to copy all links', 'error');
    }
    
    document.body.removeChild(textArea);
}

// Export to CSV
function exportToCSV() {
    const dataToUse = filteredData.length > 0 ? filteredData : currentData;
    
    if (dataToUse.length === 0) return showStatus('No data to export', 'error');
    
    let csvContent = "Receipt No.,Sales Type,Survey Model,Generated Link\n";
    dataToUse.forEach(row => {
        csvContent += `"${row.receiptNo}","${row.salesType}","${row.surveyModel}","${row.link}"\n`;
    });
    
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    const url = URL.createObjectURL(blob);
    link.setAttribute("href", url);
    link.setAttribute("download", "survey_links.csv");
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    showStatus('CSV exported successfully!', 'success');
}

// Generate QR codes
function generateQRCodes(data) {
    currentQRData = data;
    const qrSlides = document.getElementById('qrSlides');
    qrSlides.innerHTML = '';
    
    if (data.length === 0) {
        qrSlides.innerHTML = '<div class="qr-slide"><p>No data available for QR codes</p></div>';
        updateQRCounter();
        return;
    }
    
    data.forEach((item, index) => {
        const slide = document.createElement('div');
        slide.className = 'qr-slide';
        
        // Create QR code
        const qrCode = document.createElement('div');
        qrCode.className = 'qr-code';
        qrCode.id = `qr-${index}`;
        
        // Create info div
        const info = document.createElement('div');
        info.className = 'qr-info';
        info.innerHTML = `
            <div>Receipt: ${item.receiptNo}</div>
            <div>Type: ${item.salesType}</div>
        `;
        
        slide.appendChild(qrCode);
        slide.appendChild(info);
        qrSlides.appendChild(slide);
        
        // Generate QR code
        const qr = qrcode(0, 'M');
        qr.addData(item.link);
        qr.make();
        qrCode.innerHTML = qr.createImgTag(5);
    });
    
    currentQRIndex = 0;
    updateQRSlides();
    updateQRCounter();
    updateQRNavigation();
}

// Open QR modal
function openQRModal() {
    document.getElementById('qrModal').style.display = 'flex';
    generateQRCodes(currentQRData);
}

// Close QR modal
function closeQRModal() {
    document.getElementById('qrModal').style.display = 'none';
}

// Filter QR codes by sales type
function setupQRFilters() {
    document.querySelectorAll('#qrFilters .filter-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            // Update active button
            document.querySelectorAll('#qrFilters .filter-btn').forEach(b => {
                b.classList.remove('active');
            });
            this.classList.add('active');
            
            const type = this.getAttribute('data-type');
            
            if (type === 'all') {
                generateQRCodes(currentData);
            } else {
                const filtered = currentData.filter(item => item.salesType === type);
                generateQRCodes(filtered);
            }
        });
    });
}

// Navigate QR codes
function nextQR() {
    if (currentQRIndex < currentQRData.length - 1) {
        currentQRIndex++;
        updateQRSlides();
        updateQRCounter();
        updateQRNavigation();
    }
}

function prevQR() {
    if (currentQRIndex > 0) {
        currentQRIndex--;
        updateQRSlides();
        updateQRCounter();
        updateQRNavigation();
    }
}

function updateQRSlides() {
    const qrSlides = document.getElementById('qrSlides');
    qrSlides.style.transform = `translateX(-${currentQRIndex * 100}%)`;
}

function updateQRCounter() {
    const counter = document.getElementById('qrCounter');
    counter.textContent = `${currentQRIndex + 1} / ${currentQRData.length}`;
}

function updateQRNavigation() {
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    
    prevBtn.disabled = currentQRIndex === 0;
    nextBtn.disabled = currentQRIndex === currentQRData.length - 1;
}

// Add swipe functionality for QR codes
function setupSwipe() {
    const qrDisplay = document.getElementById('qrDisplay');
    let startX = 0;
    let endX = 0;
    
    qrDisplay.addEventListener('touchstart', function(e) {
        startX = e.touches[0].clientX;
    });
    
    qrDisplay.addEventListener('touchend', function(e) {
        endX = e.changedTouches[0].clientX;
        handleSwipe();
    });
    
    // Add mouse support for desktop
    qrDisplay.addEventListener('mousedown', function(e) {
        startX = e.clientX;
        document.addEventListener('mouseup', handleMouseUp);
    });
    
    function handleMouseUp(e) {
        endX = e.clientX;
        handleSwipe();
        document.removeEventListener('mouseup', handleMouseUp);
    }
    
    function handleSwipe() {
        const swipeThreshold = 50;
        const diff = startX - endX;
        
        if (Math.abs(diff) > swipeThreshold) {
            if (diff > 0) {
                // Swipe left - next
                nextQR();
            } else {
                // Swipe right - previous
                prevQR();
            }
        }
    }
}

// Clear all data
function clearData() {
    currentData = [];
    filteredData = [];
    currentQRData = [];
    currentQRIndex = 0;
    document.querySelector('#linkTable tbody').innerHTML = '';
    document.getElementById('fileInput').value = '';
    document.getElementById('fileName').textContent = 'No file chosen';
    document.getElementById('copyAllBtn').disabled = true;
    document.getElementById('exportBtn').disabled = true;
    document.getElementById('openQRBtn').disabled = true;
    document.getElementById('status').style.display = 'none';
    
    // Disable search functionality
    document.getElementById('searchBox').disabled = true;
    document.getElementById('searchBtn').disabled = true;
    document.getElementById('clearSearchBtn').disabled = true;
    document.getElementById('searchBox').value = '';
    
    // Hide filters
    document.getElementById('salesTypeFilters').style.display = 'none';
    
    // Close QR modal if open
    closeQRModal();
}

// Show status message
function showStatus(message, type) {
    const statusEl = document.getElementById('status');
    statusEl.textContent = message;
    statusEl.className = `status ${type}`;
    statusEl.style.display = 'block';
}

// Enable generate button when file is selected and show file name
document.getElementById('fileInput').addEventListener('change', function() {
    const fileName = this.files.length > 0 ? this.files[0].name : 'No file chosen';
    document.getElementById('fileName').textContent = fileName;
    document.getElementById('generateBtn').disabled = !this.files.length;
});

// Enable search when Enter key is pressed in search box
document.getElementById('searchBox').addEventListener('keyup', function(event) {
    if (event.key === 'Enter') {
        searchOrderId();
    }
});

// Close modal when clicking outside
window.addEventListener('click', function(event) {
    const modal = document.getElementById('qrModal');
    if (event.target === modal) {
        closeQRModal();
    }
});

// Initialize filters and swipe functionality
document.addEventListener('DOMContentLoaded', function() {
    setupSalesTypeFilters();
    setupQRFilters();
    setupSwipe();
});
</script>
</body>
</html>
